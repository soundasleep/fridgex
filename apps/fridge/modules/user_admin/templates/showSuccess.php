<?php
// auto-generated by sfPropelCrud
// date: 2008/07/24 15:35:45
?>

<?php echo link_to('List of users', 'user_admin/list') ?>
<h1 class="username"><?php echo $user->getNickname(); ?></h1>

<?php use_helper("My"); ?>

<?php if ($credit) { ?>
<div class="message">
	You have successfully credited <b><?php echo my_format_currency($credit->getPrice()); ?></b>
	to this user.
	<br>
	Their account balance is now <b><?php echo my_format_currency($user->getAccountCredit()); ?></b>.
</div>
<?php } ?>

<?php if ($debit) { ?>
<div class="message">
	You have successfully debited <b><?php echo my_format_currency($debit->getPrice()); ?></b>
	from this user.
	<br>
	Their account balance is now <b><?php echo my_format_currency($user->getAccountCredit()); ?></b>.
</div>
<?php } ?>

<table>
<tbody>
<tr>
<th>Id: </th>
<td><?php echo $user->getId() ?></td>
</tr>
<tr>
<th>Email: </th>
<td><?php echo mail_to($user->getEmail()) ?></td>
</tr>
<tr>
<th>Name: </th>
<td><?php echo $user->getName() ?></td>
</tr>
<tr>
<th>Nickname: </th>
<td><span class="username"><?php echo $user->getNickname() ?></span></td>
</tr>
<tr>
<th>Created at: </th>
<td><?php echo my_format_date($user->getCreatedAt()) ?></td>
</tr>
<tr>
<th>Updated at: </th>
<td><?php echo my_format_date($user->getUpdatedAt()) ?></td>
</tr>
<tr>
<th>Last login: </th>
<td><?php echo my_format_date($user->getLastLogin()) ?></td>
</tr>
<tr>
<th>Account credit: </th>
<td><?php echo my_format_currency($user->getAccountCredit()) ?></td>
</tr>
<tr>
<th>Permissions: </th>
<td>
	<?php if (!$user->getUserPermissions()) { ?>
		<i>none</i><?php } else { ?>
		<ul>
		<?php foreach ($user->getUserPermissions() as $p) { ?>
			<li><b><?php echo $p->getPermission(); ?></b> : <?php echo sfConfig::get("app_permission_".$p->getPermission(), "undefined"); ?></li>
		<?php } ?>
		</ul>
	<?php } ?>
	</td>
</tr>
</tbody>
</table>
<?php echo link_to('Edit user', 'user_admin/edit?id='.$user->getId()) ?>
<hr />

<?php if ($current_user->canDirectCredit($user)) { ?>

<?php echo form_tag("user_admin/credit"); ?>
<?php echo input_hidden_tag("id", $user->getId()); ?>
	<table>
	<thead>
	<tr>
		<th colspan="2">Direct credit</th>
	</tr>
	</thead>
	<tbody>
	<tr>
		<th>Credit: </th>
		<td>$ <?php echo input_tag("amount", "0.00"); ?></td>
	</tr>
	<tr>
		<td></td>
		<td>
			<?php echo submit_tag("Credit Account"); ?>
		</td>
	</tr>
	</tbody>
	</table>
</form>

<?php } ?>

<?php if ($current_user->canDirectDebit($user)) { ?>

<?php echo form_tag("user_admin/debit"); ?>
<?php echo input_hidden_tag("id", $user->getId()); ?>
	<table>
	<thead>
	<tr>
		<th colspan="2">Direct debit</th>
	</tr>
	</thead>
	<tbody>
	<tr>
		<th>Debit: </th>
		<td>$ <?php echo input_tag("amount", "0.00"); ?></td>
	</tr>
	<tr>
		<td></td>
		<td>
			<?php echo submit_tag("Debit Account"); ?>
		</td>
	</tr>
	</tbody>
	</table>
</form>

<?php } ?>

<h2>Recent Activity</h2>

<table>
<thead>
<tr>
  <th>ID</th>
  <th>Date</th>
  <th>Activity</th>
  <th>Price</th>
  <th>Quantity</th>
  <th>Surcharge</th>
  <th>Credit</th>
  <th>Debit</th>
</tr>
</thead>
<tbody>
<?php foreach ($purchases as $purchase) { ?>
<tr class="<?php if ($purchase->isCancelled()) echo "cancelled"; ?>">
	<td><?php echo $purchase->getId(); ?></td>
	<td><?php echo my_format_date($purchase->getCreatedAt()); ?></td>
<?php if ($purchase->getIsDirectCredit()) { ?>
	<?php if ($purchase->getPrice() > 0) { ?>
		<td>
			Direct credit by <span class="username"><?php echo $purchase->getCreditedByUser() ? link_to($purchase->getCreditedByUser()->getNickname(), "user_admin/show?id=". $purchase->getCreditedByUser()->getId()) : "null"; ?></span>
			<?php if (!$purchase->getVerifiedBy()) { ?>
				(<?php echo link_to("Unverified", "purchase/credit"); ?>)
			<?php } ?>
		</td>
		<td class="currency"><?php echo my_format_currency($purchase->getPrice()); ?></td>
		<td class="number"></td>
		<td class="currency"></td>
		<td class="currency"><?php echo my_format_currency($purchase->getPrice()); ?></td>
		<td class="currency"></td>
	<?php } else { ?>
		<td>
			Direct debit by <span class="username"><?php echo $purchase->getCreditedByUser() ? link_to($purchase->getCreditedByUser()->getNickname(), "user_admin/show?id=". $purchase->getCreditedByUser()->getId()) : "null"; ?></span>
			<?php if (!$purchase->getVerifiedBy()) { ?>
				(<?php echo link_to("Unverified", "purchase/credit"); ?>)
			<?php } ?>
		</td>
		<td class="currency"><?php echo my_format_currency($purchase->getPrice()); ?></td>
		<td class="number"></td>
		<td class="currency"></td>
		<td class="currency"></td>
		<td class="currency"><?php echo my_format_currency($purchase->getPrice()); ?></td>
	<?php } ?>
<?php } elseif ($purchase->getQuantity() < 0) { ?>
	<td>
		Purchase: <?php echo $purchase->getProduct() ? link_to($purchase->getProduct()->getTitle(), "product/show?id=".$purchase->getProduct()->getId()) : "null"; ?>
		<?php if ($purchase->isCancelled() && $purchase->getCancelledBy()) { ?>
			(cancelled by <?php echo link_to($purchase->getCancelledBy()->getNickname(), "user_admin/show?id=".$purchase->getCancelledBy()->getId(), array("class" => "username")); ?>)
		<?php } ?>
	</td>
	<td class="currency"><?php echo my_format_currency($purchase->getPrice()); ?></td>
	<td class="number"><?php echo format_number(-$purchase->getQuantity()); ?></td>
	<td class="currency"><?php echo my_format_currency($purchase->getSurcharge()); ?></td>
	<td class="currency"></td>
	<td class="currency"><?php echo my_format_currency(($purchase->getPrice() + $purchase->getSurcharge()) * $purchase->getQuantity()); ?></td>
<?php } else { ?>
	<td>
		Credit: <?php echo $purchase->getProduct() ? link_to($purchase->getProduct()->getTitle(), "product/show?id=".$purchase->getProduct()->getId()) : "null"; ?>
		<?php if (!$purchase->getVerifiedBy()) { ?>
			(<?php echo link_to("Unverified", "purchase/credit"); ?>)
		<?php } ?>
		<?php if ($purchase->isCancelled() && $purchase->getCancelledBy()) { ?>
			(cancelled by <?php echo link_to($purchase->getCancelledBy()->getNickname(), "user_admin/show?id=".$purchase->getCancelledBy()->getId(), array("class" => "username")); ?>)
		<?php } ?>
	</td>
	<td class="currency"><?php echo my_format_currency($purchase->getPrice()); ?></td>
	<td class="number"><?php echo format_number($purchase->getQuantity()); ?></td>
	<td class="currency"></td>
	<td class="currency"><?php echo my_format_currency(($purchase->getPrice() + $purchase->getSurcharge()) * $purchase->getQuantity()); ?></td>
	<td class="currency"></td>
<?php } ?>
</tr>
<?php } ?>

<?php if (!$purchases) { ?>
<tr>
	<td colspan="7" class="no_activity">(No recent activity in the last 14 days.)</td>
</tr>
<?php } ?>

<tr>
	<th colspan="6">Account Balance</th>
<?php if ($user->canViewSurcharge()) { ?>
	<th></th>
<?php } ?>
	<th class="currency"><?php if ($user->getAccountCredit() > 0) echo my_format_currency($user->getAccountCredit()); ?></th>
	<th class="currency"><?php if ($user->getAccountCredit() <= 0) echo my_format_currency($user->getAccountCredit()); ?></th>
</tr>
</tbody>
</table>

